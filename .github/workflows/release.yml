name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      attestations: write
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Verify signed annotated tag
        env:
          RELEASE_GPG_PUBLIC_KEY: ${{ secrets.RELEASE_GPG_PUBLIC_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${RELEASE_GPG_PUBLIC_KEY:-}" ]]; then
            echo "Missing RELEASE_GPG_PUBLIC_KEY secret"
            exit 1
          fi

          TAG_NAME="${GITHUB_REF_NAME}"
          git fetch --tags --force

          if [[ "$(git cat-file -t "$TAG_NAME")" != "tag" ]]; then
            echo "Tag '$TAG_NAME' is not an annotated tag"
            exit 1
          fi

          export GNUPGHOME
          GNUPGHOME="$(mktemp -d)"
          trap 'rm -rf "$GNUPGHOME"' EXIT

          echo "$RELEASE_GPG_PUBLIC_KEY" | gpg --batch --import
          git verify-tag "$TAG_NAME"

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "22"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"
          scope: "@rinshari"

      - name: Verify release tag matches package version
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          PKG_VERSION="$(node -p "require('./package.json').version")"
          EXPECTED_TAG="v${PKG_VERSION}"
          if [[ "$TAG_NAME" != "$EXPECTED_TAG" ]]; then
            echo "E_RELEASE_TAG_VERSION_MISMATCH: expected '$EXPECTED_TAG' but received '$TAG_NAME'"
            exit 1
          fi

      - name: Resolve npm dist-tag from package version
        id: npm_dist_tag
        run: |
          set -euo pipefail
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if [[ "$PKG_VERSION" == *-* ]]; then
            DIST_TAG="next"
          else
            DIST_TAG="latest"
          fi
          echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: npm ci

      - name: Run checks
        run: |
          npm test
          npm run validate:schemas
          npm run conformance

      - name: Validate trust-store lifecycle contracts
        run: |
          npm run trust:lint -- --trust-store config/policy-trust-store.sample.json --format json
          npm run trust:lint -- --trust-store config/policy-trust-store.v2.sample.json --format json

      - name: Generate SBOM (CycloneDX)
        run: npm run sbom:generate -- --output sbom.cdx.json

      - name: Build conformance bundle
        run: |
          set -euo pipefail
          zip -r seven-shadow-conformance-bundle.zip conformance

      - name: Build provider contract fixture bundle
        id: provider_fixtures
        run: |
          set -euo pipefail
          npm run build
          BUNDLE="$(node dist/scripts/build-provider-fixture-bundle.js)"
          echo "bundle=$BUNDLE" >> "$GITHUB_OUTPUT"

      - name: Pack release artifacts
        id: pack
        run: |
          set -euo pipefail
          TARBALL="$(npm pack --silent)"
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          sha256sum "$TARBALL" sbom.cdx.json seven-shadow-conformance-bundle.zip "${{ steps.provider_fixtures.outputs.bundle }}" > SHA256SUMS.txt

      - name: Install Cosign
        uses: sigstore/cosign-installer@4959ce089c160fddf62f7b42464195ba1a56d382

      - name: Keyless sign SBOM and checksums
        run: |
          set -euo pipefail
          cosign sign-blob --yes --output-signature sbom.cdx.json.sig --output-certificate sbom.cdx.json.pem sbom.cdx.json
          cosign sign-blob --yes --output-signature SHA256SUMS.txt.sig --output-certificate SHA256SUMS.txt.pem SHA256SUMS.txt

      - name: Verify signed SBOM and checksum artifacts
        env:
          TAG_NAME: ${{ github.ref_name }}
          REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          set -euo pipefail
          CERT_IDENTITY="${SERVER_URL}/${REPOSITORY}/.github/workflows/release.yml@refs/tags/${TAG_NAME}"
          cosign verify-blob \
            --certificate-identity "$CERT_IDENTITY" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate sbom.cdx.json.pem \
            --signature sbom.cdx.json.sig \
            sbom.cdx.json
          cosign verify-blob \
            --certificate-identity "$CERT_IDENTITY" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate SHA256SUMS.txt.pem \
            --signature SHA256SUMS.txt.sig \
            SHA256SUMS.txt

      - name: Attest tarball provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f
        with:
          subject-path: ${{ steps.pack.outputs.tarball }}

      - name: Verify tarball provenance attestation
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          set -euo pipefail
          CERT_IDENTITY="${SERVER_URL}/${REPOSITORY}/.github/workflows/release.yml@${GITHUB_REF}"
          gh attestation verify "${{ steps.pack.outputs.tarball }}" \
            --repo "$REPOSITORY" \
            --cert-identity "$CERT_IDENTITY" \
            --cert-oidc-issuer "https://token.actions.githubusercontent.com"

      - name: Publish to npm with provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish "${{ steps.pack.outputs.tarball }}" --provenance --access public --tag "${{ steps.npm_dist_tag.outputs.dist_tag }}"

      - name: Publish GitHub release + checksums
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          gh release create "$TAG_NAME" \
            --title "$TAG_NAME" \
            --notes "Automated release for $TAG_NAME" \
            "${{ steps.pack.outputs.tarball }}" \
            seven-shadow-conformance-bundle.zip \
            "${{ steps.provider_fixtures.outputs.bundle }}" \
            sbom.cdx.json \
            sbom.cdx.json.sig \
            sbom.cdx.json.pem \
            SHA256SUMS.txt \
            SHA256SUMS.txt.sig \
            SHA256SUMS.txt.pem
