name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  dco:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: Verify DCO sign-off
        run: |
          set -euo pipefail
          git fetch origin "${GITHUB_BASE_REF}" --depth=1
          missing=0
          while IFS= read -r commit; do
            if ! git show -s --format=%B "$commit" | grep -qi '^Signed-off-by:'; then
              echo "Missing Signed-off-by footer in commit: $commit"
              missing=1
            fi
          done < <(git rev-list "origin/${GITHUB_BASE_REF}..HEAD")
          if [[ "$missing" -ne 0 ]]; then
            echo "DCO check failed. Please amend commits with 'git commit --amend -s' or add sign-off on each commit."
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test
        run: npm test

  schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Validate Schemas
        run: npm run validate:schemas

      - name: Validate Security Gates
        run: npm run validate:security-gates

  trust-rollout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Validate trust stores
        run: |
          npm run trust:lint -- --trust-store config/policy-trust-store.sample.json --format json
          npm run trust:lint -- --trust-store config/policy-trust-store.v2.sample.json --format json

  rc-soak:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Run RC soak replay gate
        run: npm run soak:rc -- --iterations 5 --report rc-soak-report.json

  fuzz:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Property Tests
        run: npm run test:property

      - name: Fuzz Tests
        run: npm run test:fuzz

  conformance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Run conformance suite
        run: npm run conformance

  provider-contract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Run provider contract suite
        run: npm run test:provider-contract

  accessibility:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Run accessibility snapshot gate
        run: npm run test:accessibility

  dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Build dashboard assets
        run: npm run dashboard:build

      - name: Run dashboard unit/integration tests
        run: npm run dashboard:test

      - name: Install Playwright browser dependencies
        run: npx playwright install --with-deps chromium

      - name: Run dashboard browser smoke test
        run: npm run dashboard:test:e2e
